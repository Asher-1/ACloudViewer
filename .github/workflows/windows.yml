# - librealsense upgrade needed to build with MSVC 17
# - MSVC 17 and CUDA 12.4+ error while building CreateCUDAHashBackend.cu (Debug only)
# - PyTorch Ops in debug mode - DLL initialization error while loading cloudViewer_torch_ops.dll
# - CUDA - Draw.exe does not run due to CUDA DLL path issues

name: Windows
permissions: {}

# TODO: conda do not support python3.13 now

on:
  workflow_dispatch:
    inputs:
      developer_build:
        description: "Set to OFF for Release wheels"
        required: false
        default: "ON"

  push:
    branches:
      - main

  release:
    types: [released]

  pull_request:
    types: [opened, reopened, synchronize] # Rebuild on new pushes to PR

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PIP_VER: "23.2.1"
  WHEEL_VER: "0.38.4"
  STOOLS_VER: "67.3.2"
  JEDI_VER: "0.17.2"  # https://github.com/ipython/ipython/issues/12740
  IDNA_VER: "2.8"  # https://github.com/psf/requests/issues/5710
  CUDA_VERSION: "12.6.0" # CUDA_VERSION: "11.8.0"
  SRC_DIR: "D:\\a\\ACloudViewer\\ACloudViewer"
  INSTALL_DIR: "C:\\dev\\cloudViewer_install"
  NPROC: 8
  DEVELOPER_BUILD: ${{ github.event.inputs.developer_build || 'ON' }}

jobs:
  windows:
    permissions:
      contents: write  # upload
      actions: write   # release
    runs-on: windows-2022
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    strategy:
      fail-fast: false
      matrix:
        python_version: ['3.12']
        BUILD_SHARED_LIBS: [ON, OFF]
        STATIC_RUNTIME: [ON, OFF]
        BUILD_CUDA_MODULE: [ON, OFF]
        CONFIG: [Release, Debug]
        exclude:
          - BUILD_SHARED_LIBS: ON
          - STATIC_RUNTIME: ON
        include:
          - BUILD_SHARED_LIBS: OFF
          - STATIC_RUNTIME: OFF
    env:
      CONDA_DEP_FILE_CLOUDVIEWER: ".ci/conda_windows_cloudViewer.yml"

    steps:
      - name: Setup DEVELOPER_BUILD
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "release") {
            echo "DEVELOPER_BUILD=OFF" >> $env:GITHUB_ENV
          } else {
            echo "DEVELOPER_BUILD=$env:DEVELOPER_BUILD" >> $env:GITHUB_ENV
          }
      - name: Disk space used
        run: Get-PSDrive

      - name: Install CUDA
        uses: Jimver/cuda-toolkit@v0.2.23
        if: ${{ matrix.BUILD_CUDA_MODULE == 'ON' }}
        id: cuda-toolkit
        with:
          cuda: "${{ env.CUDA_VERSION }}"
          sub-packages: '["nvcc", "visual_studio_integration", "cublas", "cublas_dev", "cudart", "cusolver", "cusolver_dev", "cusparse", "cusparse_dev", "npp", "npp_dev", "thrust", "nvtx", "curand", "curand_dev", "nvrtc_dev"]'
          method: 'network'
          use-github-cache: 'false'
          use-local-cache: 'false'
  
      - name: Setup ENV
        if: ${{ matrix.BUILD_CUDA_MODULE == 'ON' }}
        run: |
          $CUDA_VER_FULL = "${{ env.CUDA_VERSION }}"
          $CUDA_VER_ARR = $CUDA_VER_FULL.Split(".")
          $CUDA_VER = "$($CUDA_VER_ARR[0]).$($CUDA_VER_ARR[1])"
          $CUDA_VER_ID = "$($CUDA_VER_ARR[0])_$($CUDA_VER_ARR[1])"

          # Add CUDA environment variables.
          $CUDA_PATH = "${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          echo "CUDA_PATH=$CUDA_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CUDA_PATH_V$CUDA_VER_ID=$CUDA_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$CUDA_PATH\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          echo "DEVELOPER_BUILD is $env:DEVELOPER_BUILD"

      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up python version
        run: |
          (Get-Content ${{ env.CONDA_DEP_FILE_CLOUDVIEWER }}) -replace "3.8", "${{ matrix.python_version }}" | Set-Content ${{ env.CONDA_DEP_FILE_CLOUDVIEWER }}

      # DGM: without caching, using conda on Windows takes a long time...
      - name: Set up Python environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          architecture: 'x64'
          activate-environment: cloudViewer
          auto-activate-base: false
          environment-file: ${{ env.CONDA_DEP_FILE_CLOUDVIEWER }}

      - name: Install dependencies
        # deploy QtIFW for installer and deploy 3rdparty_downloads.zip for fast building on windows
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/Asher-1/CloudViewerUpdate/main/tools/QtIFW-4.6.1-win.zip" -OutFile "C:\QtIFW-4.6.1-win.zip"
          Expand-Archive "C:\QtIFW-4.6.1-win.zip" "C:\" -Force && Remove-Item "C:\QtIFW-4.6.1-win.zip"
          $env:PATH = "C:\QtIFW-4.6.1-win\bin;$env:PATH"
          echo $env:PATH
          echo "PATH=$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          Invoke-WebRequest -Uri "https://github.com/Asher-1/cloudViewer_downloads/releases/download/1.9.4/3rdparty_downloads.zip" -OutFile "3rdparty_downloads.zip"
          Expand-Archive "3rdparty_downloads.zip" "${{ env.SRC_DIR }}" -Force && Remove-Item "3rdparty_downloads.zip"

      - name: Fix Windows 11 appverifUI issues
        run: |
          echo "Running Windows 11 appverifUI fix script..."
          $ErrorActionPreference = 'Continue'
          & "${{ env.SRC_DIR }}\scripts\platforms\windows\fix_win11_appverifUI.bat"
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "appverifUI fix script returned exit code: $LASTEXITCODE"
          }
          $ErrorActionPreference = 'Stop'

      - name: Build ACloudViewer App
        if: ${{ matrix.BUILD_SHARED_LIBS == 'OFF' && matrix.STATIC_RUNTIME == 'OFF' && matrix.CONFIG == 'Release' }}
        working-directory: ${{ env.SRC_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          # Set environment variables for build script
          # These will be used by build_win_app.ps1
          $env:STATIC_RUNTIME = "${{ matrix.STATIC_RUNTIME }}"
          $env:DEVELOPER_BUILD = "${{ env.DEVELOPER_BUILD }}"
          $env:BUILD_SHARED_LIBS = "${{ matrix.BUILD_SHARED_LIBS }}"
          $env:BUILD_CUDA_MODULE = "${{ matrix.BUILD_CUDA_MODULE }}"
          # IGNORE_TEST: Set to ON to skip tests in build script (tests run separately in workflow)
          $env:IGNORE_TEST = "ON"
          echo "IGNORE_TEST=$env:IGNORE_TEST"  | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          $env:ONLY_BUILD_CUDA = "${{ matrix.BUILD_CUDA_MODULE }}"
          echo "ONLY_BUILD_CUDA=$env:ONLY_BUILD_CUDA"  | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # Call build script with named parameters
          & "${{ env.SRC_DIR }}\scripts\build_win_app.ps1" `
            -PythonVersion "${{ matrix.python_version }}" `
            -ACloudViewerInstall "${{ env.INSTALL_DIR }}"
          
          # Extract package installer name for subsequent steps
          $PACKAGE_INSTALLER_NAME = (Get-ChildItem (Join-Path "${{ env.INSTALL_DIR }}" "ACloudViewer-*.exe")).Name
          echo "PACKAGE_INSTALLER_NAME=$PACKAGE_INSTALLER_NAME" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run C++ unit tests
        if: ${{ matrix.CONFIG == 'Release' && matrix.BUILD_CUDA_MODULE == 'OFF' }}
        working-directory: ${{ env.SRC_DIR }}\build
        run: |
          $ErrorActionPreference = 'Continue'
          
          # Check if build directory exists
          $buildDir = "${{ env.SRC_DIR }}\build"
          if (-not (Test-Path $buildDir)) {
            Write-Error "Build directory not found: $buildDir"
            exit 1
          }
          
          # Check if test executable exists
          $testExe = Join-Path $buildDir "bin\${{ matrix.CONFIG }}\tests.exe"
          if (-not (Test-Path $testExe)) {
            Write-Error "Test executable not found: $testExe"
            Write-Host "Current directory: $(Get-Location)"
            Write-Host "Listing bin directory:"
            if (Test-Path (Join-Path $buildDir "bin")) {
              Get-ChildItem (Join-Path $buildDir "bin") -Recurse -Filter "*.exe" | Select-Object FullName
            }
            exit 1
          }
          
          Write-Host "Running C++ unit tests from: $(Get-Location)"
          Write-Host "Test executable: $testExe"
          Write-Host "BUILD_CUDA_MODULE: ${{ matrix.BUILD_CUDA_MODULE }}"
          Write-Host "Add --gtest_random_seed=SEED to the test command to repeat this test sequence."
          
          # Run the tests
          & $testExe --gtest_shuffle --gtest_filter=-*ReduceSum64bit2DCase0*:*ReduceSum64bit2DCase3*
          $testResult = $LASTEXITCODE
          
          if ($testResult -ne 0) {
            Write-Error "C++ unit tests failed with exit code: $testResult"
            exit $testResult
          }
          
          Write-Host "C++ unit tests passed successfully."
      - name: Upload ACloudViewer to GitHub artifacts
        if: ${{ matrix.BUILD_SHARED_LIBS == 'OFF' && matrix.STATIC_RUNTIME == 'OFF' && matrix.CONFIG == 'Release' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_INSTALLER_NAME }}
          path: ${{ env.INSTALL_DIR }}\${{ env.PACKAGE_INSTALLER_NAME }}
          if-no-files-found: error
      - name: Update devel release
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload main-devel ${{ env.INSTALL_DIR }}\${{ env.PACKAGE_INSTALLER_NAME }} --clobber
          gh release view main-devel
      - name: Public App Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          fail_on_unmatched_files: false
          generate_release_notes: false
          prerelease: false
          # body_path: ${{github.workspace}}/CHANGELOG.md
          files: |
            ${{ env.INSTALL_DIR }}\${{ env.PACKAGE_INSTALLER_NAME }}
      - name: Disk space used
        run: Get-PSDrive

  build-wheel:
    name: Build wheel
    permissions:
      contents: write  # upload
      actions: write   # release
    runs-on: windows-2022
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    strategy:
      fail-fast: false
      # https://github.community/t/how-to-conditionally-include-exclude-items-in-matrix-eg-based-on-branch/16853/6
      matrix:
        BUILD_CUDA_MODULE: [ON, OFF]
        python_version: ['3.10', '3.11', '3.12']
        is_main:
          - ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') }}
        exclude:
          - BUILD_CUDA_MODULE: OFF
          - is_main: false
            python_version: '3.10'
          - is_main: false
            python_version: '3.11'

    env:
      BUILD_PYTORCH_OPS: ON
      BUILD_TENSORFLOW_OPS: OFF
      BUILD_JUPYTER_EXTENSION: ON
      BUILD_AZURE_KINECT: ON
      BUILD_LIBREALSENSE: ON
      CLOUDVIEWER_ML_ROOT: ${{ github.workspace }}/CloudViewer-ML

    steps:
      - name: Setup DEVELOPER_BUILD
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "release") {
            echo "DEVELOPER_BUILD=OFF" >> $env:GITHUB_ENV
          } else {
            echo "DEVELOPER_BUILD=$env:DEVELOPER_BUILD" >> $env:GITHUB_ENV
          }

      - name: Install CUDA
        uses: Jimver/cuda-toolkit@v0.2.23
        if: ${{ matrix.BUILD_CUDA_MODULE == 'ON' }}
        id: cuda-toolkit
        with:
          cuda: "${{ env.CUDA_VERSION }}"
          sub-packages: '["nvcc", "visual_studio_integration", "cublas", "cublas_dev", "cudart", "cusolver", "cusolver_dev", "cusparse", "cusparse_dev", "npp", "npp_dev", "thrust", "nvtx", "curand", "curand_dev", "nvrtc_dev"]'
          method: 'network'
          use-github-cache: 'false'
          use-local-cache: 'false'

      - name: Setup ENV
        if: ${{ matrix.BUILD_CUDA_MODULE == 'ON' }}
        run: |
          $CUDA_VER_FULL = "${{ env.CUDA_VERSION }}"
          $CUDA_VER_ARR = $CUDA_VER_FULL.Split(".")
          $CUDA_VER = "$($CUDA_VER_ARR[0]).$($CUDA_VER_ARR[1])"
          $CUDA_VER_ID = "$($CUDA_VER_ARR[0])_$($CUDA_VER_ARR[1])"

          # Add CUDA environment variables.
          $CUDA_PATH = "${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          echo "CUDA_PATH=$CUDA_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CUDA_PATH_V$CUDA_VER_ID=$CUDA_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$CUDA_PATH\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          echo "DEVELOPER_BUILD is $env:DEVELOPER_BUILD"

      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Checkout CloudViewer-ML source code
        uses: actions/checkout@v4
        with:
          repository: Asher-1/CloudViewer-ML
          ref: main
          path: ${{ env.CLOUDVIEWER_ML_ROOT }}

      # DGM: without caching, using conda on Windows takes a long time...
      - name: Set up Python environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ matrix.python_version }}
          auto-activate-base: true

      - name: Install 3rdparty_downloads
        working-directory: ${{ env.SRC_DIR }}
        run: |
          Invoke-WebRequest -Uri "https://github.com/Asher-1/cloudViewer_downloads/releases/download/1.9.4/3rdparty_downloads.zip" -OutFile "3rdparty_downloads.zip"
          Expand-Archive "3rdparty_downloads.zip" "${{ env.SRC_DIR }}" -Force && Remove-Item "3rdparty_downloads.zip"

      - name: Fix Windows 11 appverifUI issues (Wheel Build)
        run: |
          echo "Running Windows 11 appverifUI fix script for wheel build..."
          $ErrorActionPreference = 'Continue'
          & "${{ env.SRC_DIR }}\scripts\platforms\windows\fix_win11_appverifUI.bat"
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "appverifUI fix script returned exit code: $LASTEXITCODE"
          }
          $ErrorActionPreference = 'Stop'

      - name: Config and Building
        working-directory: ${{ env.SRC_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          # no need to test due to to next step is test-wheel
          $env:IGNORE_TEST = "ON"
          echo "IGNORE_TEST=$env:IGNORE_TEST" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # Call build script with named parameters
          & "${{ env.SRC_DIR }}\scripts\build_win_wheel.ps1" `
            -PythonVersion "${{ matrix.python_version }}" `
            -ACloudViewerInstall "${{ env.INSTALL_DIR }}" `
            -CloudViewerMLRoot "${{ env.CLOUDVIEWER_ML_ROOT }}"

          $PIP_PKG_NAME=(Get-ChildItem (Join-Path "${{ env.INSTALL_DIR }}" "cloudviewer-*.whl")).Name
          $PIP_CPU_PKG_NAME=(Get-ChildItem (Join-Path "${{ env.INSTALL_DIR }}" "cloudviewer_cpu*.whl")).Name
          echo "PIP_PKG_NAME=$PIP_PKG_NAME"  | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PIP_CPU_PKG_NAME=$PIP_CPU_PKG_NAME"  | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload Wheel to GitHub artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PIP_PKG_NAME }}
          path: |
            ${{ env.INSTALL_DIR }}/${{ env.PIP_PKG_NAME }}
            ${{ env.INSTALL_DIR }}/${{ env.PIP_CPU_PKG_NAME }}
          if-no-files-found: error
      
      - name: Update devel release
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload main-devel ${{ env.INSTALL_DIR }}/${{ env.PIP_PKG_NAME }} ${{ env.INSTALL_DIR }}/${{ env.PIP_CPU_PKG_NAME }} --clobber
          gh release view main-devel

      - name: Public Wheel Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          fail_on_unmatched_files: false
          generate_release_notes: false
          prerelease: false
          files: |
            ${{ env.INSTALL_DIR }}/${{ env.PIP_PKG_NAME }}
            ${{ env.INSTALL_DIR }}/${{ env.PIP_CPU_PKG_NAME }}

  test-wheel:
    name: Test wheel
    permissions:
      contents: read
    runs-on: windows-2022
    needs: [build-wheel]
    strategy:
      fail-fast: false
      matrix:
        python_version: ['3.10', '3.11', '3.12']
        is_main:
          - ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') }}
        exclude:
          - is_main: false
            python_version: '3.10'
          - is_main: false
            python_version: '3.11'

    env:
      BUILD_PYTORCH_OPS: ON
      BUILD_TENSORFLOW_OPS: OFF
      CONDA_DEP_FILE: ".ci/conda_windows.yml"
      CLOUDVIEWER_ML_ROOT: ${{ github.workspace }}/CloudViewer-ML

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Checkout CloudViewer-ML source code
        uses: actions/checkout@v4
        with:
          repository: Asher-1/CloudViewer-ML
          ref: main
          path: ${{ env.CLOUDVIEWER_ML_ROOT }}

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: cloudviewer*win*.whl
          merge-multiple: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python_version }}

      - name: Test Python package (CPU)
        env:
          BUILD_CUDA_MODULE: OFF
        run: |
          python -V
          $env:PIP_VER = "${{ env.PIP_VER }}"
          $env:CLOUDVIEWER_SOURCE_ROOT = (Get-Location).Path
          . util/ci_utils.ps1
          $py_tag=(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          if (Test-Path -Path "pip_package") {
            $PIP_PKG_NAME=(Get-ChildItem pip_package\cloudviewer_cpu*-$py_tag-*.whl).Name
          } else {
            $PIP_PKG_NAME=(Get-ChildItem cloudviewer_cpu*-$py_tag-*.whl).Name
          }
          echo "Testing wheel: $PIP_PKG_NAME"
          Test-Wheel -wheel_path $PIP_PKG_NAME
      - name: Run Python unit tests (CPU)
        run: |
          $ErrorActionPreference = 'Stop'
          cloudViewer_test.venv\Scripts\Activate.ps1
          python -V
          echo "Installing test dependencies..."
          python -m pip install -r python/requirements_test.txt
          echo "Running CloudViewer python tests (CPU)..."
          echo "Add --randomly-seed=SEED to the test command to reproduce test order."
          echo "Testing ML and ML Ops disabled"
          python -m pytest python/test/ --ignore python/test/ml_ops/
          deactivate
      - name: Test Python package (CUDA)
        env:
          BUILD_CUDA_MODULE: ON
        run: |
          python -V
          $env:PIP_VER = "${{ env.PIP_VER }}"
          $env:CLOUDVIEWER_SOURCE_ROOT = (Get-Location).Path
          . util/ci_utils.ps1
          $py_tag=(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          if (Test-Path -Path "pip_package") {
            $PIP_PKG_NAME=(Get-ChildItem pip_package\cloudviewer-*-$py_tag-*.whl).Name
          } else {
            $PIP_PKG_NAME=(Get-ChildItem cloudviewer-*-$py_tag-*.whl).Name
          }
          echo "Testing wheel: $PIP_PKG_NAME"
          Test-Wheel -wheel_path $PIP_PKG_NAME
      - name: Run Python unit tests (CUDA)
        run: |
          $ErrorActionPreference = 'Stop'
          cloudViewer_test.venv\Scripts\Activate.ps1
          echo "Installing test dependencies..."
          python -V
          python -m pip install -r python/requirements_test.txt
          echo "Running CloudViewer python tests (CUDA)..."
          echo "Add --randomly-seed=SEED to the test command to reproduce test order."
          echo "Testing ML and ML Ops disabled"
          python -m pytest python/test/ --ignore python/test/ml_ops/
          deactivate
