name: Documentation

on:
  workflow_dispatch:
    inputs:
      developer_build:
        description: 'Set to OFF for Release documentation'
        required: false
        default: 'ON'
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]
  release:
    types: [released, edited]  # Trigger when release is published

concurrency:
  # For PR builds: use separate group, can cancel previous
  # For main/release: use shared group to prevent concurrent deployments
  group: ${{ github.event_name == 'pull_request' && format('docs-pr-{0}', github.event.pull_request.number) || 'pages-deployment' }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ===========================================================================
  # Job 1: Build Documentation (runs for all events including PRs)
  # ===========================================================================
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # For uploading artifacts and releases
      pull-requests: write   # For commenting on pull requests
      issues: write          # For creating issue comments
    
    # Output variables for the deploy job
    outputs:
      is_release: ${{ steps.config.outputs.is_release }}
      release_version: ${{ steps.config.outputs.release_version }}
      doc_version: ${{ steps.config.outputs.doc_version }}
      artifact_name: ${{ steps.config.outputs.artifact_name }}
      should_deploy: ${{ steps.config.outputs.should_deploy }}
    
    env:
      DEVELOPER_BUILD: ${{ github.event.inputs.developer_build || (github.event_name == 'release' && 'OFF' || 'ON') }}
    
    steps:
      - name: Determine version and build mode
        id: config
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Build Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Determine if this is a release build
          IS_RELEASE="${{ github.event_name == 'release' && 'true' || 'false' }}"
          RELEASE_VERSION="${{ github.event.release.tag_name || '' }}"
          DOC_VERSION="${{ github.event.release.tag_name != '' && github.event.release.tag_name || 'latest' }}"
          
          # Determine artifact name
          if [ "$IS_RELEASE" == "true" ] && [ -n "$RELEASE_VERSION" ]; then
            ARTIFACT_NAME="acloudviewer-${RELEASE_VERSION}-docs"
          else
            ARTIFACT_NAME="acloudviewer-${{ github.sha }}-docs"
          fi
          
          # Determine if we should deploy (main branch or release, not PR)
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.event_name }}" == "release" ]; then
            SHOULD_DEPLOY="true"
          else
            SHOULD_DEPLOY="false"
          fi
          
          # Set outputs for deploy job
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "doc_version=${DOC_VERSION}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "should_deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
          
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Is Release: ${IS_RELEASE}"
          echo "Release Version: ${RELEASE_VERSION}"
          echo "Documentation Version: ${DOC_VERSION}"
          echo "Developer Build: ${{ env.DEVELOPER_BUILD }}"
          echo "Should Deploy: ${SHOULD_DEPLOY}"
          echo ""
          
          if [ "$IS_RELEASE" == "true" ]; then
            echo "ğŸ¯ Release build detected - will archive documentation to version directory"
            echo "   Version: ${DOC_VERSION}"
            echo "   Archive path: documentation/${DOC_VERSION}/"
          elif [ "$SHOULD_DEPLOY" == "true" ]; then
            echo "ğŸ“ Development build - will deploy to latest documentation"
            echo "   Path: documentation/"
          else
            echo "ğŸ” PR build - documentation will be built but not deployed"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout ACloudViewer source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Fetch or generate downloads_data.json
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Obtaining downloads_data.json"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Strategy: Fetch from main-devel release or generate from API"
          echo ""
          
          # Try to fetch from main-devel release (managed by update-downloads workflow)
          echo "ğŸ” Attempting to fetch from main-devel release..."
          if gh release download main-devel --pattern "downloads_data.json" --dir docs 2>/dev/null; then
            echo "âœ… Successfully fetched from main-devel release"
            echo "  - Size: $(du -h docs/downloads_data.json | cut -f1)"
            echo "  - Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
            echo "  - Last update: $(jq -r '.generated_at' docs/downloads_data.json)"
            echo ""
            echo "â„¹ï¸  This data is managed by the 'update-downloads' workflow"
          else
            # Fallback: Generate from GitHub API
            echo "âš ï¸  Could not fetch from release, generating from GitHub API..."
            echo ""
            
            python3 docs/automation/scripts/scan_releases.py
            
            if [ -f "docs/downloads_data.json" ]; then
              echo "âœ… Generated downloads_data.json from GitHub API"
              echo "  - Size: $(du -h docs/downloads_data.json | cut -f1)"
              echo "  - Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
            else
              echo "âŒ Failed to obtain downloads_data.json!"
              echo "Creating minimal placeholder..."
              echo '{"generated_at":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","version_metadata":{},"download_links":{}}' > docs/downloads_data.json
            fi
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Maximize build space
        run: |
          echo "ğŸ§¹ Cleaning up disk space..."
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build documentation Docker image
        run: |
          echo "ğŸ³ Building documentation Docker image..."
          echo "Build parameters:"
          echo "  - BASE_IMAGE: ubuntu:22.04"
          echo "  - DEVELOPER_BUILD: ${DEVELOPER_BUILD}"
          echo ""
          
          docker build \
            --progress=plain \
            --build-arg BASE_IMAGE=ubuntu:22.04 \
            --build-arg DEVELOPER_BUILD=${DEVELOPER_BUILD} \
            -t acloudviewer-ci:docs \
            -f docker/Dockerfile.docs \
            .
          
          echo ""
          echo "âœ… Docker image built successfully"
          docker images | grep acloudviewer-ci
      
      - name: Extract documentation from Docker
        run: |
          echo "ğŸ“¦ Extracting documentation..."
          
          # Run Docker container to copy documentation archive
          docker run \
            -v "${GITHUB_WORKSPACE}:/opt/mount" \
            --rm acloudviewer-ci:docs \
            bash -c "cp /root/ACloudViewer/acloudviewer-*-docs.tar.gz /opt/mount/ \
                  && chown $(id -u):$(id -g) /opt/mount/acloudviewer-*-docs.tar.gz"
          
          # Verify extraction
          if [ ! -f acloudviewer-*-docs.tar.gz ]; then
            echo "âŒ Documentation archive not found!"
            exit 1
          fi
          
          # Determine archive name based on event type
          IS_RELEASE="${{ steps.config.outputs.is_release }}"
          RELEASE_VERSION="${{ steps.config.outputs.release_version }}"
          
          if [ "$IS_RELEASE" == "true" ] && [ -n "$RELEASE_VERSION" ]; then
            # For releases, use version tag
            ARCHIVE_NAME="acloudviewer-${RELEASE_VERSION}-docs.tar.gz"
            mv acloudviewer-*-docs.tar.gz "${ARCHIVE_NAME}"
            echo "ğŸ“‹ Release archive: ${ARCHIVE_NAME}"
          else
            # For development builds, use SHA
            ARCHIVE_NAME="acloudviewer-${{ github.sha }}-docs.tar.gz"
            mv acloudviewer-*-docs.tar.gz "${ARCHIVE_NAME}"
            echo "ğŸ“‹ Development archive: ${ARCHIVE_NAME}"
          fi
          
          echo "ğŸ“‹ Archive details:"
          ls -lh "${ARCHIVE_NAME}"
          
          # Extract for GitHub Pages deployment
          echo ""
          echo "ğŸ“‚ Extracting documentation for deployment..."
          mkdir -p docs-output
          tar -xzf "${ARCHIVE_NAME}" -C docs-output/
          
          # Verify extraction
          if [ ! -f "docs-output/index.html" ]; then
            echo "âš ï¸  Warning: index.html not found in extracted documentation"
          fi
          
          echo ""
          echo "âœ… Documentation extracted successfully"
          echo ""
          echo "ğŸ“Š Extracted content:"
          echo "  - Total files: $(find docs-output -type f | wc -l)"
          echo "  - HTML files: $(find docs-output -name '*.html' | wc -l)"
          echo "  - Total size: $(du -sh docs-output | cut -f1)"
          echo ""
          echo "ğŸ“ Top-level structure:"
          ls -la docs-output/
      
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.config.outputs.artifact_name }}
          path: acloudviewer-*-docs.tar.gz
          if-no-files-found: error
          compression-level: 0  # Already compressed
      
      - name: Upload docs-output for deploy job
        if: steps.config.outputs.should_deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docs-output
          path: docs-output/
          if-no-files-found: error
          retention-days: 1  # Short retention, only needed for deploy job
      
      - name: Upload website-deploy for deploy job
        if: steps.config.outputs.should_deploy == 'true'
        run: |
          echo "ğŸ“‹ Preparing main website with generated downloads_data.json..."
          echo ""
          
          # Create website deployment directory
          mkdir -p website-deploy
          
          # Copy main website files (excluding build artifacts)
          echo "Copying main website files..."
          rsync -av --exclude='_out' --exclude='_build' --exclude='*.pyc' \
                --exclude='__pycache__' --exclude='.pytest_cache' \
                docs/ website-deploy/
          
          # ============================================================
          # Replace @VERSION@ placeholder in index.html
          # ============================================================
          echo ""
          echo "ğŸ”„ Replacing @VERSION@ placeholder in website files..."
          
          # Determine version to use
          IS_RELEASE="${{ steps.config.outputs.is_release }}"
          RELEASE_VERSION="${{ steps.config.outputs.release_version }}"
          
          if [ "$IS_RELEASE" == "true" ] && [ -n "$RELEASE_VERSION" ]; then
            # For releases, use the release tag (e.g., v3.9.4)
            WEBSITE_VERSION="$RELEASE_VERSION"
          else
            # For main branch, extract version from CMakeLists.txt
            if [ -f "CMakeLists.txt" ]; then
              MAJOR=$(grep "set(PROJECT_VERSION_MAJOR" CMakeLists.txt | grep -oE '[0-9]+' | head -1)
              MINOR=$(grep "set(PROJECT_VERSION_MINOR" CMakeLists.txt | grep -oE '[0-9]+' | head -1)
              PATCH=$(grep "set(PROJECT_VERSION_PATCH" CMakeLists.txt | grep -oE '[0-9]+' | head -1)
              if [ -n "$MAJOR" ] && [ -n "$MINOR" ] && [ -n "$PATCH" ]; then
                WEBSITE_VERSION="${MAJOR}.${MINOR}.${PATCH}-dev"
              else
                WEBSITE_VERSION="dev"
              fi
            else
              WEBSITE_VERSION="dev"
            fi
          fi
          
          echo "  Version to use: $WEBSITE_VERSION"
          
          # Replace @VERSION@ in index.html
          if [ -f "website-deploy/index.html" ]; then
            if grep -q '@VERSION@' website-deploy/index.html; then
              sed -i "s/@VERSION@/$WEBSITE_VERSION/g" website-deploy/index.html
              echo "  âœ… Replaced @VERSION@ with $WEBSITE_VERSION in index.html"
            else
              echo "  â„¹ï¸  No @VERSION@ placeholder found in index.html"
            fi
          fi
          
          # ============================================================
          # Ensure downloads_data.json is included
          # ============================================================
          if [ -f "docs/downloads_data.json" ]; then
            echo "âœ… downloads_data.json ready for deployment"
            cp docs/downloads_data.json website-deploy/
            echo "  Size: $(du -h docs/downloads_data.json | cut -f1)"
            echo "  Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
          else
            echo "âš ï¸ downloads_data.json not found, using placeholder"
            echo '{"generated_at":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","version_metadata":{},"download_links":{}}' > website-deploy/downloads_data.json
          fi
          
          # Create a README for the documentation subdirectory link
          cat > website-deploy/DOCUMENTATION.md << 'DOCEOF'
          # ACloudViewer Documentation
          
          Full API documentation is available at: [/documentation/](/documentation/)
          
          ## Documentation Structure
          
          - **Main Website**: Current page (project info, downloads, getting started)
          - **API Documentation**: [/documentation/](/documentation/) (Python API, C++ API, Tutorials)
          
          ## Quick Links
          
          - [Python API Reference](/documentation/python_api/)
          - [C++ API Reference](/documentation/cpp_api/)
          - [Tutorials](/documentation/tutorial/)
          DOCEOF
          
          echo ""
          echo "âœ… Main website prepared for deployment"
          echo ""
          echo "ğŸ“Š Website deployment statistics:"
          echo "  - Total files: $(find website-deploy -type f | wc -l)"
          echo "  - Total size: $(du -sh website-deploy | cut -f1)"
      
      - name: Upload website-deploy artifact
        if: steps.config.outputs.should_deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: website-deploy
          path: website-deploy/
          if-no-files-found: error
          retention-days: 1
      
      - name: Update main-devel release
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ“¤ Uploading to main-devel release..."
          gh release upload main-devel \
            acloudviewer-${{ github.sha }}-docs.tar.gz \
            --clobber
          gh release view main-devel
      
      - name: Upload documentation archive to release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_VERSION="${{ steps.config.outputs.release_version }}"
          echo "ğŸ“¤ Uploading documentation archive to release ${RELEASE_VERSION}..."
          
          # Rename archive to include version tag for easy identification
          VERSIONED_ARCHIVE="acloudviewer-${RELEASE_VERSION}-docs.tar.gz"
          cp acloudviewer-*-docs.tar.gz "${VERSIONED_ARCHIVE}"
          
          gh release upload "${RELEASE_VERSION}" \
            "${VERSIONED_ARCHIVE}" \
            --clobber
          
          echo "âœ… Documentation archive uploaded to release"
          echo "   This archive will be used to preserve version history in future deployments"
      
      - name: Comment on PR with documentation preview
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const artifactName = '${{ steps.config.outputs.artifact_name }}';
            
            // Find the archive file
            const files = fs.readdirSync('.').filter(f => f.endsWith('-docs.tar.gz'));
            const archiveFile = files[0] || 'acloudviewer-docs.tar.gz';
            let fileSize = 'unknown';
            try {
              const stats = fs.statSync(archiveFile);
              fileSize = (stats.size / 1024 / 1024).toFixed(2);
            } catch (e) {
              console.log('Could not get file size:', e.message);
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“š **Documentation Preview**\n\n` +
                    `Documentation has been built successfully!\n\n` +
                    `- **Artifact**: \`${artifactName}\`\n` +
                    `- **Download**: Available in workflow run artifacts\n` +
                    `- **Size**: ~${fileSize} MB\n\n` +
                    `After merge, documentation will be automatically deployed to:\n` +
                    `https://asher-1.github.io/ACloudViewer/documentation/`
            });

  # ===========================================================================
  # Job 2: Deploy Documentation (only runs for main branch or releases)
  # ===========================================================================
  deploy-docs:
    runs-on: ubuntu-latest
    needs: build-docs
    # Only deploy for main branch or releases, NOT for PRs
    if: needs.build-docs.outputs.should_deploy == 'true'
    
    permissions:
      contents: read         # For downloading artifacts
      pages: write           # For deploying to GitHub Pages
      id-token: write        # For GitHub Pages deployment (OIDC token)
    
    # Configure GitHub Pages environment for artifact-based deployment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    env:
      IS_RELEASE: ${{ needs.build-docs.outputs.is_release }}
      RELEASE_VERSION: ${{ needs.build-docs.outputs.release_version }}
      DOC_VERSION: ${{ needs.build-docs.outputs.doc_version }}
    
    steps:
      - name: Checkout (for gh CLI)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
          sparse-checkout-cone-mode: false
      
      - name: Download docs-output artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-output
          path: docs-output/
      
      - name: Download website-deploy artifact
        uses: actions/download-artifact@v4
        with:
          name: website-deploy
          path: website-deploy/
      
      - name: Preserve existing version archives from GitHub Releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Preserving existing version archives from GitHub Releases"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Strategy: Download documentation archives from GitHub Releases"
          echo "         (Version archives are stored as release assets, not in git)"
          echo ""
          echo "Current build info:"
          echo "  IS_RELEASE: ${{ env.IS_RELEASE }}"
          echo "  RELEASE_VERSION: ${{ env.RELEASE_VERSION }}"
          echo "  DOC_VERSION: ${{ env.DOC_VERSION }}"
          echo ""
          
          # Create directory for preserved archives
          mkdir -p preserved-versions/documentation
          
          # Get list of releases with documentation archives
          echo "ğŸ” Scanning GitHub Releases for documentation archives..."
          echo ""
          
          # First, list all releases to debug
          echo "ğŸ“‹ All releases:"
          gh release list --limit 20 || echo "  (failed to list releases)"
          echo ""
          
          RELEASES=$(gh release list --limit 20 --json tagName -q '.[].tagName' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' || true)
          
          FOUND_COUNT=0
          NOT_FOUND_COUNT=0
          
          if [ -n "$RELEASES" ]; then
            echo "âœ… Found versioned releases:"
            echo "$RELEASES"
            echo ""
            
            for VERSION in $RELEASES; do
              echo "  - Checking $VERSION..."
              
              # List assets for this release to debug
              echo "    Assets in $VERSION:"
              gh release view "$VERSION" --json assets --jq '.assets[].name' 2>/dev/null | head -10 || echo "    (failed to list assets)"
              
              # Try to download documentation archive from release
              DOCS_ARCHIVE="acloudviewer-${VERSION}-docs.tar.gz"
              if gh release download "$VERSION" --pattern "$DOCS_ARCHIVE" --dir /tmp 2>/dev/null; then
                echo "    âœ… Found and downloaded $DOCS_ARCHIVE"
                mkdir -p "preserved-versions/documentation/$VERSION"
                tar -xzf "/tmp/$DOCS_ARCHIVE" -C "preserved-versions/documentation/$VERSION/" 2>/dev/null || {
                  echo "    âš ï¸  Failed to extract $DOCS_ARCHIVE"
                }
                rm -f "/tmp/$DOCS_ARCHIVE"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              else
                echo "    â­ï¸  No documentation archive found for $VERSION"
                echo "       Expected: $DOCS_ARCHIVE"
                echo "       ğŸ’¡ To add: manually upload acloudviewer-${VERSION}-docs.tar.gz to this release"
                NOT_FOUND_COUNT=$((NOT_FOUND_COUNT + 1))
              fi
              echo ""
            done
            
            echo "ğŸ“Š Summary:"
            echo "  - Found archives: $FOUND_COUNT"
            echo "  - Missing archives: $NOT_FOUND_COUNT"
            echo ""
            echo "ğŸ“Š Preserved version archives:"
            ls -la preserved-versions/documentation/ 2>/dev/null | grep -E '^d.*v[0-9]+' || echo "  (none found)"
            if [ -d "preserved-versions/documentation" ]; then
              for dir in preserved-versions/documentation/*/; do
                if [ -d "$dir" ]; then
                  echo "  - $(basename $dir): $(find "$dir" -type f | wc -l) files, $(du -sh "$dir" | cut -f1)"
                fi
              done
            fi
          else
            echo "â„¹ï¸  No versioned releases found"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Merge website and documentation for unified deployment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Merging website and documentation for unified deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Create unified deployment directory
          mkdir -p unified-deploy
          
          # Always copy main website to root (for both main branch and releases)
          echo "ğŸ“„ Copying main website files to root..."
          cp -r website-deploy/* unified-deploy/
          echo "âœ… Main website copied successfully"
          echo ""
          
          # Determine documentation deployment path
          if [ "${{ env.IS_RELEASE }}" == "true" ] && [ -n "${{ env.RELEASE_VERSION }}" ]; then
            # For releases: Archive to version directory + update latest
            DOC_VERSION_PATH="documentation/${{ env.DOC_VERSION }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ¯ Release build detected - Creating permanent archive"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # 1. Archive complete documentation to version-specific directory (æ°¸ä¹…å­˜æ¡£)
            echo "ğŸ“¦ Archiving complete documentation to: ${DOC_VERSION_PATH}/"
            mkdir -p "unified-deploy/${DOC_VERSION_PATH}"
            cp -r docs-output/* "unified-deploy/${DOC_VERSION_PATH}/"
            echo "âœ… Version archive created: ${DOC_VERSION_PATH}/"
            echo ""
            
            # 2. Also update latest (release becomes the new latest stable version)
            echo "ğŸ”„ Updating latest documentation (latest stable release)"
            mkdir -p unified-deploy/documentation
            cp -r docs-output/* unified-deploy/documentation/
            echo "âœ… Latest documentation updated to release version ${{ env.RELEASE_VERSION }}"
            echo ""
            
            echo "ğŸ“š Version History: Documentation archived at:"
            echo "   - Latest: https://asher-1.github.io/ACloudViewer/documentation/"
            echo "   - ${{ env.RELEASE_VERSION }}: https://asher-1.github.io/ACloudViewer/${DOC_VERSION_PATH}/"
          else
            # For main branch (beta/development): Only update latest
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”§ Development build - Updating latest documentation"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“š Updating latest documentation from main branch (beta/dev)..."
            mkdir -p unified-deploy/documentation
            cp -r docs-output/* unified-deploy/documentation/
            echo "âœ… Latest documentation updated from main branch"
          fi
          
          # Restore preserved version archives (critical for keeping version history)
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Restoring preserved version archives"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -d "preserved-versions/documentation" ]; then
            # Copy preserved version archives (won't overwrite current deployment)
            for VERSION_DIR in preserved-versions/documentation/v*/; do
              if [ -d "$VERSION_DIR" ]; then
                VERSION_NAME=$(basename "$VERSION_DIR")
                TARGET_DIR="unified-deploy/documentation/$VERSION_NAME"
                
                # Don't overwrite if this version was just deployed (for release builds)
                if [ ! -d "$TARGET_DIR" ]; then
                  echo "  âœ… Restoring: documentation/$VERSION_NAME/"
                  mkdir -p "$TARGET_DIR"
                  cp -r "$VERSION_DIR"* "$TARGET_DIR/"
                else
                  echo "  â­ï¸  Skipping: documentation/$VERSION_NAME/ (already exists in current deployment)"
                fi
              fi
            done
            echo ""
            echo "ğŸ“Š All version archives in deployment:"
            ls -la unified-deploy/documentation/ | grep -E '^d.*v[0-9]+' || echo "  (none)"
          else
            echo "  â„¹ï¸  No preserved version archives to restore"
          fi
          
          echo ""
          echo "âœ… Unified deployment prepared"
          echo ""
          echo "ğŸ“Š Final deployment structure:"
          echo "  - Total files: $(find unified-deploy -type f | wc -l)"
          echo "  - Total size: $(du -sh unified-deploy | cut -f1)"
          echo "  - Root files: $(ls unified-deploy/ | wc -l)"
          echo "  - Documentation files: $(find unified-deploy/documentation -type f | wc -l)"
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "  - Version archive files: $(find unified-deploy/documentation/${{ env.DOC_VERSION }} -type f 2>/dev/null | wc -l)"
          fi
          echo ""
          echo "ğŸ“ Top-level structure:"
          ls -la unified-deploy/ | head -20
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo ""
            echo "ğŸ“ Documentation version structure:"
            ls -la unified-deploy/documentation/ | head -20
          fi
          echo ""
      
      # ============================================================================
      # GitHub Pages Artifact Deployment (No git objects pollution!)
      # This method uses GitHub's artifact storage instead of git branches,
      # so it won't affect git pull/fetch for other developers.
      # ============================================================================
      
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./unified-deploy
          # Note: This uploads the entire unified-deploy directory as a single artifact
          # No git objects are created - deployment uses GitHub's artifact storage
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # This deploys directly from the artifact, NOT through git
        # Benefits:
        # - No gh-pages branch needed
        # - No git objects pollution
        # - git pull/fetch won't download documentation files
        # - Other developers won't be affected by documentation updates
      
      - name: Verify deployment structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Deployment Verification"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Deployment Summary:"
          echo "  âœ… Documentation built successfully"
          echo "  âœ… Main website prepared ($(du -sh website-deploy | cut -f1))"
          echo "  âœ… Unified deployment merged ($(du -sh unified-deploy | cut -f1))"
          
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "  âœ… Release documentation archived to version directory"
            echo "  âœ… Latest documentation updated to release version"
            echo "  âœ… Deployed to GitHub Pages with version history"
          else
            echo "  âœ… Beta/dev documentation updated to latest"
            echo "  âœ… Deployed to GitHub Pages (main branch)"
          fi
          
          echo ""
          echo "ğŸŒ Expected GitHub Pages structure:"
          echo "  https://asher-1.github.io/ACloudViewer/"
          echo "  â”œâ”€â”€ index.html (main website)"
          echo "  â”œâ”€â”€ downloads_data.json"
          echo "  â”œâ”€â”€ DOCUMENTATION.md"
          
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "  â””â”€â”€ documentation/"
            echo "      â”œâ”€â”€ index.html (latest stable - ${{ env.RELEASE_VERSION }})"
            echo "      â”œâ”€â”€ python_api/"
            echo "      â”œâ”€â”€ cpp_api/"
            echo "      â”œâ”€â”€ tutorial/"
            echo "      â””â”€â”€ ${{ env.DOC_VERSION }}/ (permanent version archive)"
            echo "          â”œâ”€â”€ index.html"
            echo "          â”œâ”€â”€ python_api/"
            echo "          â”œâ”€â”€ cpp_api/"
            echo "          â””â”€â”€ tutorial/"
          else
            echo "  â””â”€â”€ documentation/ (latest beta/dev)"
            echo "      â”œâ”€â”€ index.html"
            echo "      â”œâ”€â”€ python_api/"
            echo "      â”œâ”€â”€ cpp_api/"
            echo "      â””â”€â”€ tutorial/"
          fi
          
          echo ""
          echo "ğŸ“š Documentation URLs:"
          echo "  - Main Website: https://asher-1.github.io/ACloudViewer/"
          
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "  - Latest Stable Documentation: https://asher-1.github.io/ACloudViewer/documentation/"
            echo "  - Latest Stable Python API: https://asher-1.github.io/ACloudViewer/documentation/python_api/"
            echo "  - Latest Stable C++ API: https://asher-1.github.io/ACloudViewer/documentation/cpp_api/"
            echo "  - Latest Stable Tutorials: https://asher-1.github.io/ACloudViewer/documentation/tutorial/"
            echo ""
            echo "ğŸ“¦ Permanent Version Archive:"
            echo "  - Version ${{ env.RELEASE_VERSION }}: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/"
            echo "  - Python API: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/python_api/"
            echo "  - C++ API: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/cpp_api/"
            echo "  - Tutorials: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/tutorial/"
          else
            echo "  - Latest Beta/Dev Documentation: https://asher-1.github.io/ACloudViewer/documentation/"
            echo "  - Latest Beta/Dev Python API: https://asher-1.github.io/ACloudViewer/documentation/python_api/"
            echo "  - Latest Beta/Dev C++ API: https://asher-1.github.io/ACloudViewer/documentation/cpp_api/"
            echo "  - Latest Beta/Dev Tutorials: https://asher-1.github.io/ACloudViewer/documentation/tutorial/"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
