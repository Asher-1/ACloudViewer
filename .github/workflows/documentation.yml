name: Documentation

on:
  workflow_dispatch:
    inputs:
      developer_build:
        description: 'Set to OFF for Release documentation'
        required: false
        default: 'ON'
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # For uploading artifacts and releases
      pages: write           # For deploying to GitHub Pages
      id-token: write        # For GitHub Pages deployment
      pull-requests: write   # For commenting on pull requests
      issues: write          # For creating issue comments
    env:
      DEVELOPER_BUILD: ${{ github.event.inputs.developer_build || 'ON' }}
    
    steps:
      - name: Checkout ACloudViewer source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Fetch or generate downloads_data.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ Obtaining downloads_data.json"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Strategy: Fetch from gh-pages branch (auto-updated by update-downloads workflow)"
          echo ""
          
          # Try to fetch from gh-pages branch (most up-to-date)
          echo "ðŸ” Attempting to fetch from gh-pages branch..."
          if git fetch origin gh-pages:gh-pages 2>/dev/null && \
             git show gh-pages:downloads_data.json > docs/downloads_data.json 2>/dev/null; then
            echo "âœ… Successfully fetched from gh-pages branch"
            echo "  - Size: $(du -h docs/downloads_data.json | cut -f1)"
            echo "  - Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
            echo "  - Last update: $(jq -r '.generated_at' docs/downloads_data.json)"
            echo ""
            echo "â„¹ï¸  This data is automatically updated by the 'update-downloads' workflow"
            echo "â„¹ï¸  No need to regenerate during documentation build"
          else
            # Fallback: Generate from GitHub API (for first-time builds or if gh-pages doesn't exist)
            echo "âš ï¸  Could not fetch from gh-pages, generating from GitHub API..."
            echo ""
            
            python3 docs/automation/scripts/scan_releases.py
            
            if [ -f "docs/downloads_data.json" ]; then
              echo "âœ… Generated downloads_data.json from GitHub API"
              echo "  - Size: $(du -h docs/downloads_data.json | cut -f1)"
              echo "  - Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
              echo ""
              echo "ðŸ“ Note: This is a temporary snapshot"
              echo "ðŸ“ The 'update-downloads' workflow will keep it updated automatically"
            else
              echo "âŒ Failed to obtain downloads_data.json!"
              echo "Creating minimal placeholder..."
              echo '{"generated_at":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","version_metadata":{},"download_links":{}}' > docs/downloads_data.json
            fi
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Maximize build space
        run: |
          echo "ðŸ§¹ Cleaning up disk space..."
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build documentation Docker image
        run: |
          echo "ðŸ³ Building documentation Docker image..."
          echo "Build parameters:"
          echo "  - BASE_IMAGE: ubuntu:22.04"
          echo "  - DEVELOPER_BUILD: ${DEVELOPER_BUILD}"
          echo ""
          
          docker build \
            --progress=plain \
            --build-arg BASE_IMAGE=ubuntu:22.04 \
            --build-arg DEVELOPER_BUILD=${DEVELOPER_BUILD} \
            -t acloudviewer-ci:docs \
            -f docker/Dockerfile.docs \
            .
          
          echo ""
          echo "âœ… Docker image built successfully"
          docker images | grep acloudviewer-ci
      
      - name: Extract documentation from Docker
        run: |
          echo "ðŸ“¦ Extracting documentation..."
          
          # Run Docker container to copy documentation archive
          docker run \
            -v "${GITHUB_WORKSPACE}:/opt/mount" \
            --rm acloudviewer-ci:docs \
            bash -c "cp /root/ACloudViewer/acloudviewer-*-docs.tar.gz /opt/mount/ \
                  && chown $(id -u):$(id -g) /opt/mount/acloudviewer-*-docs.tar.gz"
          
          # Verify extraction
          if [ ! -f acloudviewer-*-docs.tar.gz ]; then
            echo "âŒ Documentation archive not found!"
            exit 1
          fi
          
          # Rename to use GitHub SHA
          mv acloudviewer-*-docs.tar.gz acloudviewer-${GITHUB_SHA}-docs.tar.gz
          
          echo "ðŸ“‹ Archive details:"
          ls -lh acloudviewer-${GITHUB_SHA}-docs.tar.gz
          
          # Extract for GitHub Pages deployment
          echo ""
          echo "ðŸ“‚ Extracting documentation for deployment..."
          mkdir -p docs-output
          tar -xzf acloudviewer-${GITHUB_SHA}-docs.tar.gz -C docs-output/
          
          # Verify extraction
          if [ ! -f "docs-output/index.html" ]; then
            echo "âš ï¸  Warning: index.html not found in extracted documentation"
          fi
          
          echo ""
          echo "âœ… Documentation extracted successfully"
          echo ""
          echo "ðŸ“Š Extracted content:"
          echo "  - Total files: $(find docs-output -type f | wc -l)"
          echo "  - HTML files: $(find docs-output -name '*.html' | wc -l)"
          echo "  - Total size: $(du -sh docs-output | cut -f1)"
          echo ""
          echo "ðŸ“ Top-level structure:"
          ls -la docs-output/
      
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: acloudviewer-${{ github.sha }}-docs
          path: acloudviewer-${{ github.sha }}-docs.tar.gz
          if-no-files-found: error
          compression-level: 0  # Already compressed
      
      - name: Update main-devel release
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ“¤ Uploading to main-devel release..."
          gh release upload main-devel \
            acloudviewer-${{ github.sha }}-docs.tar.gz \
            --clobber
          gh release view main-devel
      
      - name: Prepare main website for deployment
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ“‹ Preparing main website with generated downloads_data.json..."
          echo ""
          
          # Create website deployment directory
          mkdir -p website-deploy
          
          # Copy main website files (excluding build artifacts)
          echo "Copying main website files..."
          rsync -av --exclude='_out' --exclude='_build' --exclude='*.pyc' \
                --exclude='__pycache__' --exclude='.pytest_cache' \
                docs/ website-deploy/
          
          # Ensure downloads_data.json is included
          if [ -f "docs/downloads_data.json" ]; then
            echo "âœ… downloads_data.json ready for deployment"
            cp docs/downloads_data.json website-deploy/
            echo "  Size: $(du -h docs/downloads_data.json | cut -f1)"
            echo "  Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
          else
            echo "âš ï¸ downloads_data.json not found, using placeholder"
            echo '{"generated_at":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","version_metadata":{},"download_links":{}}' > website-deploy/downloads_data.json
          fi
          
          # Create a README for the documentation subdirectory link
          cat > website-deploy/DOCUMENTATION.md << 'DOCEOF'
          # ACloudViewer Documentation
          
          Full API documentation is available at: [/documentation/](/documentation/)
          
          ## Documentation Structure
          
          - **Main Website**: Current page (project info, downloads, getting started)
          - **API Documentation**: [/documentation/](/documentation/) (Python API, C++ API, Tutorials)
          
          ## Quick Links
          
          - [Python API Reference](/documentation/python_api/)
          - [C++ API Reference](/documentation/cpp_api/)
          - [Tutorials](/documentation/tutorial/)
          DOCEOF
          
          echo ""
          echo "âœ… Main website prepared for deployment"
          echo ""
          echo "ðŸ“Š Website deployment statistics:"
          echo "  - Total files: $(find website-deploy -type f | wc -l)"
          echo "  - Total size: $(du -sh website-deploy | cut -f1)"
          echo ""
          echo "ðŸ“ Top-level structure:"
          ls -la website-deploy/ | head -20
      
      - name: Merge website and documentation for unified deployment
        if: github.ref == 'refs/heads/main'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ Merging website and documentation for unified deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Create unified deployment directory
          mkdir -p unified-deploy
          
          # Copy main website (root level)
          echo "ðŸ“„ Copying main website files..."
          cp -r website-deploy/* unified-deploy/
          
          # Copy API documentation to subdirectory
          echo "ðŸ“š Copying API documentation to documentation/ subdirectory..."
          mkdir -p unified-deploy/documentation
          cp -r docs-output/* unified-deploy/documentation/
          
          echo ""
          echo "âœ… Unified deployment prepared"
          echo ""
          echo "ðŸ“Š Final deployment structure:"
          echo "  - Total files: $(find unified-deploy -type f | wc -l)"
          echo "  - Total size: $(du -sh unified-deploy | cut -f1)"
          echo "  - Root files: $(ls unified-deploy/ | wc -l)"
          echo "  - Documentation files: $(find unified-deploy/documentation -type f | wc -l)"
          echo ""
          echo "ðŸ“ Top-level structure:"
          ls -la unified-deploy/ | head -20
          echo ""
      
      - name: Deploy to GitHub Pages (unified deployment)
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./unified-deploy
          keep_files: false  # Complete replacement for clean deployment
          commit_message: "docs: deploy website + documentation from ${{ github.sha }}"
          enable_jekyll: false  # Disable Jekyll processing
          force_orphan: true  # Use orphan branch for clean history
      
      - name: Verify deployment structure
        if: github.ref == 'refs/heads/main'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” Deployment Verification"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“‹ Deployment Summary:"
          echo "  âœ… Docker image built successfully"
          echo "  âœ… Documentation extracted ($(du -sh docs-output | cut -f1))"
          echo "  âœ… Main website prepared ($(du -sh website-deploy | cut -f1))"
          echo "  âœ… Unified deployment merged ($(du -sh unified-deploy | cut -f1))"
          echo "  âœ… Deployed to GitHub Pages (single deployment)"
          echo ""
          echo "ðŸŒ Expected GitHub Pages structure:"
          echo "  https://asher-1.github.io/ACloudViewer/"
          echo "  â”œâ”€â”€ index.html (main website)"
          echo "  â”œâ”€â”€ downloads_data.json"
          echo "  â”œâ”€â”€ DOCUMENTATION.md"
          echo "  â””â”€â”€ documentation/ (API docs)"
          echo "      â”œâ”€â”€ index.html"
          echo "      â”œâ”€â”€ python_api/"
          echo "      â”œâ”€â”€ cpp_api/"
          echo "      â””â”€â”€ tutorial/"
          echo ""
          echo "ðŸ“š Documentation URLs:"
          echo "  - Main Website: https://asher-1.github.io/ACloudViewer/"
          echo "  - API Documentation: https://asher-1.github.io/ACloudViewer/documentation/"
          echo "  - Python API: https://asher-1.github.io/ACloudViewer/documentation/python_api/"
          echo "  - C++ API: https://asher-1.github.io/ACloudViewer/documentation/cpp_api/"
          echo "  - Tutorials: https://asher-1.github.io/ACloudViewer/documentation/tutorial/"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Comment on PR with documentation preview
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const artifactName = 'acloudviewer-${{ github.sha }}-docs';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ“š **Documentation Preview**\n\n` +
                    `Documentation has been built successfully!\n\n` +
                    `- **Artifact**: \`${artifactName}\`\n` +
                    `- **Download**: Available in workflow run artifacts\n` +
                    `- **Size**: ${fs.statSync('acloudviewer-${{ github.sha }}-docs.tar.gz').size / 1024 / 1024} MB\n\n` +
                    `After merge, documentation will be automatically deployed to:\n` +
                    `https://asher-1.github.io/ACloudViewer/documentation/`
            });

