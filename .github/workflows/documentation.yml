name: Documentation

on:
  workflow_dispatch:
    inputs:
      developer_build:
        description: 'Set to OFF for Release documentation'
        required: false
        default: 'ON'
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]
  release:
    types: [published, edited]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # For uploading artifacts and releases
      pages: write           # For deploying to GitHub Pages
      id-token: write        # For GitHub Pages deployment
      pull-requests: write   # For commenting on pull requests
      issues: write          # For creating issue comments
    env:
      DEVELOPER_BUILD: ${{ github.event.inputs.developer_build || (github.event_name == 'release' && 'OFF' || 'ON') }}
      IS_RELEASE: ${{ github.event_name == 'release' }}
      RELEASE_VERSION: ${{ github.event.release.tag_name || '' }}
      DOC_VERSION: ${{ github.event.release.tag_name != '' && github.event.release.tag_name || 'latest' }}
    
    steps:
      - name: Determine version and build mode
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Build Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Event: ${{ github.event_name }}"
          echo "Is Release: ${{ env.IS_RELEASE }}"
          echo "Release Version: ${{ env.RELEASE_VERSION }}"
          echo "Documentation Version: ${{ env.DOC_VERSION }}"
          echo "Developer Build: ${{ env.DEVELOPER_BUILD }}"
          echo ""
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "ğŸ¯ Release build detected - will archive documentation to version directory"
            echo "   Version: ${{ env.DOC_VERSION }}"
            echo "   Archive path: documentation/${{ env.DOC_VERSION }}/"
          else
            echo "ğŸ“ Development build - will deploy to latest documentation"
            echo "   Path: documentation/"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - name: Checkout ACloudViewer source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Fetch or generate downloads_data.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Obtaining downloads_data.json"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Strategy: Fetch from gh-pages branch (auto-updated by update-downloads workflow)"
          echo ""
          
          # Try to fetch from gh-pages branch (most up-to-date)
          echo "ğŸ” Attempting to fetch from gh-pages branch..."
          if git fetch origin gh-pages:gh-pages 2>/dev/null && \
             git show gh-pages:downloads_data.json > docs/downloads_data.json 2>/dev/null; then
            echo "âœ… Successfully fetched from gh-pages branch"
            echo "  - Size: $(du -h docs/downloads_data.json | cut -f1)"
            echo "  - Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
            echo "  - Last update: $(jq -r '.generated_at' docs/downloads_data.json)"
            echo ""
            echo "â„¹ï¸  This data is automatically updated by the 'update-downloads' workflow"
            echo "â„¹ï¸  No need to regenerate during documentation build"
          else
            # Fallback: Generate from GitHub API (for first-time builds or if gh-pages doesn't exist)
            echo "âš ï¸  Could not fetch from gh-pages, generating from GitHub API..."
            echo ""
            
            python3 docs/automation/scripts/scan_releases.py
            
            if [ -f "docs/downloads_data.json" ]; then
              echo "âœ… Generated downloads_data.json from GitHub API"
              echo "  - Size: $(du -h docs/downloads_data.json | cut -f1)"
              echo "  - Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
              echo ""
              echo "ğŸ“ Note: This is a temporary snapshot"
              echo "ğŸ“ The 'update-downloads' workflow will keep it updated automatically"
            else
              echo "âŒ Failed to obtain downloads_data.json!"
              echo "Creating minimal placeholder..."
              echo '{"generated_at":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","version_metadata":{},"download_links":{}}' > docs/downloads_data.json
            fi
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Maximize build space
        run: |
          echo "ğŸ§¹ Cleaning up disk space..."
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build documentation Docker image
        run: |
          echo "ğŸ³ Building documentation Docker image..."
          echo "Build parameters:"
          echo "  - BASE_IMAGE: ubuntu:22.04"
          echo "  - DEVELOPER_BUILD: ${DEVELOPER_BUILD}"
          echo ""
          
          docker build \
            --progress=plain \
            --build-arg BASE_IMAGE=ubuntu:22.04 \
            --build-arg DEVELOPER_BUILD=${DEVELOPER_BUILD} \
            -t acloudviewer-ci:docs \
            -f docker/Dockerfile.docs \
            .
          
          echo ""
          echo "âœ… Docker image built successfully"
          docker images | grep acloudviewer-ci
      
      - name: Extract documentation from Docker
        run: |
          echo "ğŸ“¦ Extracting documentation..."
          
          # Run Docker container to copy documentation archive
          docker run \
            -v "${GITHUB_WORKSPACE}:/opt/mount" \
            --rm acloudviewer-ci:docs \
            bash -c "cp /root/ACloudViewer/acloudviewer-*-docs.tar.gz /opt/mount/ \
                  && chown $(id -u):$(id -g) /opt/mount/acloudviewer-*-docs.tar.gz"
          
          # Verify extraction
          if [ ! -f acloudviewer-*-docs.tar.gz ]; then
            echo "âŒ Documentation archive not found!"
            exit 1
          fi
          
          # Determine archive name based on event type
          if [ "${{ env.IS_RELEASE }}" == "true" ] && [ -n "${{ env.RELEASE_VERSION }}" ]; then
            # For releases, use version tag
            ARCHIVE_NAME="acloudviewer-${{ env.RELEASE_VERSION }}-docs.tar.gz"
            mv acloudviewer-*-docs.tar.gz "${ARCHIVE_NAME}"
            echo "ğŸ“‹ Release archive: ${ARCHIVE_NAME}"
          else
            # For development builds, use SHA
            ARCHIVE_NAME="acloudviewer-${GITHUB_SHA}-docs.tar.gz"
            mv acloudviewer-*-docs.tar.gz "${ARCHIVE_NAME}"
            echo "ğŸ“‹ Development archive: ${ARCHIVE_NAME}"
          fi
          
          echo "ğŸ“‹ Archive details:"
          ls -lh "${ARCHIVE_NAME}"
          
          # Extract for GitHub Pages deployment
          echo ""
          echo "ğŸ“‚ Extracting documentation for deployment..."
          mkdir -p docs-output
          tar -xzf "${ARCHIVE_NAME}" -C docs-output/
          
          # Verify extraction
          if [ ! -f "docs-output/index.html" ]; then
            echo "âš ï¸  Warning: index.html not found in extracted documentation"
          fi
          
          echo ""
          echo "âœ… Documentation extracted successfully"
          echo ""
          echo "ğŸ“Š Extracted content:"
          echo "  - Total files: $(find docs-output -type f | wc -l)"
          echo "  - HTML files: $(find docs-output -name '*.html' | wc -l)"
          echo "  - Total size: $(du -sh docs-output | cut -f1)"
          echo ""
          echo "ğŸ“ Top-level structure:"
          ls -la docs-output/
      
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: acloudviewer-${{ env.IS_RELEASE == 'true' && env.RELEASE_VERSION || github.sha }}-docs
          path: acloudviewer-*-docs.tar.gz
          if-no-files-found: error
          compression-level: 0  # Already compressed
      
      - name: Update main-devel release
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ“¤ Uploading to main-devel release..."
          gh release upload main-devel \
            acloudviewer-${{ github.sha }}-docs.tar.gz \
            --clobber
          gh release view main-devel
      
      - name: Prepare main website for deployment
        if: github.ref == 'refs/heads/main' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: |
          echo "ğŸ“‹ Preparing main website with generated downloads_data.json..."
          echo ""
          
          # Create website deployment directory
          mkdir -p website-deploy
          
          # Copy main website files (excluding build artifacts)
          echo "Copying main website files..."
          rsync -av --exclude='_out' --exclude='_build' --exclude='*.pyc' \
                --exclude='__pycache__' --exclude='.pytest_cache' \
                docs/ website-deploy/
          
          # Ensure downloads_data.json is included
          if [ -f "docs/downloads_data.json" ]; then
            echo "âœ… downloads_data.json ready for deployment"
            cp docs/downloads_data.json website-deploy/
            echo "  Size: $(du -h docs/downloads_data.json | cut -f1)"
            echo "  Versions: $(jq '.version_metadata | length' docs/downloads_data.json)"
          else
            echo "âš ï¸ downloads_data.json not found, using placeholder"
            echo '{"generated_at":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","version_metadata":{},"download_links":{}}' > website-deploy/downloads_data.json
          fi
          
          # Create a README for the documentation subdirectory link
          cat > website-deploy/DOCUMENTATION.md << 'DOCEOF'
          # ACloudViewer Documentation
          
          Full API documentation is available at: [/documentation/](/documentation/)
          
          ## Documentation Structure
          
          - **Main Website**: Current page (project info, downloads, getting started)
          - **API Documentation**: [/documentation/](/documentation/) (Python API, C++ API, Tutorials)
          
          ## Quick Links
          
          - [Python API Reference](/documentation/python_api/)
          - [C++ API Reference](/documentation/cpp_api/)
          - [Tutorials](/documentation/tutorial/)
          DOCEOF
          
          echo ""
          echo "âœ… Main website prepared for deployment"
          echo ""
          echo "ğŸ“Š Website deployment statistics:"
          echo "  - Total files: $(find website-deploy -type f | wc -l)"
          echo "  - Total size: $(du -sh website-deploy | cut -f1)"
          echo ""
          echo "ğŸ“ Top-level structure:"
          ls -la website-deploy/ | head -20
      
      - name: Merge website and documentation for unified deployment
        if: github.ref == 'refs/heads/main' || github.event_name == 'release'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Merging website and documentation for unified deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Create unified deployment directory
          mkdir -p unified-deploy
          
          # Copy main website (root level) - only for main branch
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ğŸ“„ Copying main website files..."
            cp -r website-deploy/* unified-deploy/
          else
            echo "ğŸ“„ Skipping main website (release build)"
            # Create minimal structure for releases
            mkdir -p unified-deploy
          fi
          
          # Determine documentation deployment path
          if [ "${{ env.IS_RELEASE }}" == "true" ] && [ -n "${{ env.RELEASE_VERSION }}" ]; then
            # For releases, deploy to version-specific directory AND latest
            DOC_PATH="documentation/${{ env.DOC_VERSION }}"
            echo "ğŸ“š Archiving API documentation to version directory: ${DOC_PATH}/"
            mkdir -p "unified-deploy/${DOC_PATH}"
            cp -r docs-output/* "unified-deploy/${DOC_PATH}/"
            
            # Also deploy to latest (release becomes the new latest)
            echo "ğŸ“š Also deploying to documentation/ (latest - release version)"
            mkdir -p unified-deploy/documentation
            cp -r docs-output/* unified-deploy/documentation/
          else
            # For main branch (beta/development), ALWAYS update latest
            echo "ğŸ“š Updating latest documentation from main branch (beta)..."
            mkdir -p unified-deploy/documentation
            cp -r docs-output/* unified-deploy/documentation/
            echo "âœ… Latest documentation updated from main branch"
          fi
          
          echo ""
          echo "âœ… Unified deployment prepared"
          echo ""
          echo "ğŸ“Š Final deployment structure:"
          echo "  - Total files: $(find unified-deploy -type f | wc -l)"
          echo "  - Total size: $(du -sh unified-deploy | cut -f1)"
          echo "  - Root files: $(ls unified-deploy/ | wc -l)"
          echo "  - Documentation files: $(find unified-deploy/documentation -type f | wc -l)"
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "  - Version-specific files: $(find unified-deploy/documentation/${{ env.DOC_VERSION }} -type f 2>/dev/null | wc -l)"
          fi
          echo ""
          echo "ğŸ“ Top-level structure:"
          ls -la unified-deploy/ | head -20
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo ""
            echo "ğŸ“ Documentation version structure:"
            ls -la unified-deploy/documentation/ | head -20
          fi
          echo ""
      
      - name: Set commit message
        if: github.ref == 'refs/heads/main' || github.event_name == 'release'
        run: |
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "COMMIT_MSG=docs: archive documentation for release ${{ env.RELEASE_VERSION }}" >> $GITHUB_ENV
          else
            echo "COMMIT_MSG=docs: deploy website + documentation from ${{ github.sha }}" >> $GITHUB_ENV
          fi
      
      - name: Deploy to GitHub Pages (unified deployment)
        if: github.ref == 'refs/heads/main' || github.event_name == 'release'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./unified-deploy
          keep_files: true  # Keep existing files to preserve version history
          commit_message: ${{ env.COMMIT_MSG }}
          enable_jekyll: false  # Disable Jekyll processing
          force_orphan: true  # Use orphan branch to avoid history bloat (reduces git pull size)
      
      - name: Verify deployment structure
        if: github.ref == 'refs/heads/main' || github.event_name == 'release'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Deployment Verification"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Deployment Summary:"
          echo "  âœ… Docker image built successfully"
          echo "  âœ… Documentation extracted ($(du -sh docs-output | cut -f1))"
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "  âœ… Main website prepared ($(du -sh website-deploy | cut -f1))"
            echo "  âœ… Beta documentation updated to latest (from main branch)"
          fi
          echo "  âœ… Unified deployment merged ($(du -sh unified-deploy | cut -f1))"
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "  âœ… Deployed to GitHub Pages (version archive + latest)"
          else
            echo "  âœ… Deployed to GitHub Pages (latest - beta from main branch)"
          fi
          echo ""
          echo "ğŸŒ Expected GitHub Pages structure:"
          echo "  https://asher-1.github.io/ACloudViewer/"
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "  â”œâ”€â”€ index.html (main website)"
            echo "  â”œâ”€â”€ downloads_data.json"
            echo "  â”œâ”€â”€ DOCUMENTATION.md"
          fi
          echo "  â””â”€â”€ documentation/ (API docs - latest/beta)"
          echo "      â”œâ”€â”€ index.html"
          echo "      â”œâ”€â”€ python_api/"
          echo "      â”œâ”€â”€ cpp_api/"
          echo "      â”œâ”€â”€ tutorial/"
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo "      â””â”€â”€ ${{ env.DOC_VERSION }}/ (version archive)"
            echo "          â”œâ”€â”€ index.html"
            echo "          â”œâ”€â”€ python_api/"
            echo "          â”œâ”€â”€ cpp_api/"
            echo "          â””â”€â”€ tutorial/"
          fi
          echo ""
          echo "ğŸ“š Documentation URLs:"
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "  - Main Website: https://asher-1.github.io/ACloudViewer/"
          fi
          echo "  - Latest/Beta API Documentation: https://asher-1.github.io/ACloudViewer/documentation/"
          echo "  - Latest/Beta Python API: https://asher-1.github.io/ACloudViewer/documentation/python_api/"
          echo "  - Latest/Beta C++ API: https://asher-1.github.io/ACloudViewer/documentation/cpp_api/"
          echo "  - Latest/Beta Tutorials: https://asher-1.github.io/ACloudViewer/documentation/tutorial/"
          if [ "${{ env.IS_RELEASE }}" == "true" ]; then
            echo ""
            echo "ğŸ“¦ Version-specific URLs:"
            echo "  - Version ${{ env.RELEASE_VERSION }}: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/"
            echo "  - Python API: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/python_api/"
            echo "  - C++ API: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/cpp_api/"
            echo "  - Tutorials: https://asher-1.github.io/ACloudViewer/documentation/${{ env.DOC_VERSION }}/tutorial/"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Comment on PR with documentation preview
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const artifactName = 'acloudviewer-${{ github.sha }}-docs';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“š **Documentation Preview**\n\n` +
                    `Documentation has been built successfully!\n\n` +
                    `- **Artifact**: \`${artifactName}\`\n` +
                    `- **Download**: Available in workflow run artifacts\n` +
                    `- **Size**: ${fs.statSync('acloudviewer-${{ github.sha }}-docs.tar.gz').size / 1024 / 1024} MB\n\n` +
                    `After merge, documentation will be automatically deployed to:\n` +
                    `https://asher-1.github.io/ACloudViewer/documentation/`
            });

