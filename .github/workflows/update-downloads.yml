name: Update Downloads Data

# This workflow updates downloads_data.json and stores it in a release asset
# It does NOT deploy to GitHub Pages directly to avoid overwriting documentation
# The documentation.yml workflow will pick up the updated file during deployment
on:
  # Automatically triggered after build workflows complete
  workflow_run:
    workflows: ["Windows"]  # Trigger after these workflows finish
    types: [completed]
    branches: [main]
  
  # Trigger when a release is published
  release:
    types: [published, deleted]
  
  # Allow manual trigger with options
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        type: boolean
        default: false
      
      trigger_docs_deploy:
        description: 'Trigger documentation workflow after update'
        required: false
        type: boolean
        default: false
      
      cleanup_old_versions:
        description: 'Remove versions older than specified days (0 = keep all)'
        required: false
        type: number
        default: 0
      
      max_versions:
        description: 'Maximum number of versions to keep (0 = unlimited)'
        required: false
        type: number
        default: 0
      
      dry_run:
        description: 'Dry run - show what would be updated without saving'
        required: false
        type: boolean
        default: false
  
  # Trigger from other workflows
  workflow_call:

concurrency:
  group: update-downloads
  cancel-in-progress: false

jobs:
  update-downloads-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For uploading release assets
    
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    
    steps:
      - name: Checkout main branch for scripts
        uses: actions/checkout@v4
        with:
          ref: main
          sparse-checkout: |
            docs/automation/scripts/
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download existing downloads_data.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Fetching existing downloads_data.json"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          mkdir -p existing
          
          # Try to fetch from main-devel release (where we store it)
          echo "ğŸ” Checking main-devel release..."
          if gh release download main-devel --pattern "downloads_data.json" --dir existing 2>/dev/null; then
            echo "âœ… Found existing downloads_data.json in main-devel release"
            echo "  - Size: $(du -h existing/downloads_data.json | cut -f1)"
            echo "  - Versions: $(jq '.version_metadata | length' existing/downloads_data.json)"
          else
            # Fallback: try to fetch from GitHub Pages
            echo "âš ï¸  Not found in release, trying GitHub Pages..."
            PAGES_URL="https://asher-1.github.io/ACloudViewer/downloads_data.json"
            if curl -fsSL "$PAGES_URL" -o existing/downloads_data.json 2>/dev/null; then
              echo "âœ… Found existing downloads_data.json on GitHub Pages"
              echo "  - Size: $(du -h existing/downloads_data.json | cut -f1)"
              echo "  - Versions: $(jq '.version_metadata | length' existing/downloads_data.json)"
            else
              echo "âš ï¸  No existing downloads_data.json found (first time?)"
              echo '{"generated_at":"","version_metadata":{},"download_links":{}}' > existing/downloads_data.json
            fi
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Generate latest downloads_data.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Scanning GitHub Releases for Download Data"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â° Trigger: ${{ github.event_name }}"
          echo "ğŸ• Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          
          # Show manual trigger options if applicable
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ”§ Manual Trigger Options:"
            echo "  - Force update: ${{ github.event.inputs.force_update }}"
            echo "  - Trigger docs deploy: ${{ github.event.inputs.trigger_docs_deploy }}"
            echo "  - Cleanup old (days): ${{ github.event.inputs.cleanup_old_versions }}"
            echo "  - Max versions: ${{ github.event.inputs.max_versions }}"
            echo "  - Dry run: ${{ github.event.inputs.dry_run }}"
            echo ""
          fi
          
          # Run scan script
          python3 docs/automation/scripts/scan_releases.py
          
          # Check if generation succeeded
          if [ -f "docs/downloads_data.json" ]; then
            mv docs/downloads_data.json downloads_data.json.new
            
            echo ""
            echo "âœ… New downloads_data.json generated"
            echo "  - Size: $(du -h downloads_data.json.new | cut -f1)"
            echo "  - Versions: $(jq '.version_metadata | length' downloads_data.json.new)"
            echo ""
            echo "ğŸ“Š Available versions:"
            jq -r '.version_metadata | to_entries[] | "  - \(.key) (\(.value.release_date))"' downloads_data.json.new | sort -V
          else
            echo "âŒ Failed to generate downloads_data.json"
            exit 1
          fi
          
          # Apply manual trigger filters if specified
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo ""
            echo "ğŸ”§ Applying manual trigger filters..."
            
            # Cleanup old versions
            CLEANUP_DAYS="${{ github.event.inputs.cleanup_old_versions }}"
            if [ "$CLEANUP_DAYS" != "0" ] && [ -n "$CLEANUP_DAYS" ]; then
              echo "  ğŸ—‘ï¸  Removing versions older than $CLEANUP_DAYS days..."
              CUTOFF_DATE=$(date -u -d "$CLEANUP_DAYS days ago" +%Y-%m-%d)
              
              jq --arg cutoff "$CUTOFF_DATE" '
                .version_metadata = (.version_metadata | to_entries | 
                  map(select(.value.release_date >= $cutoff)) | 
                  from_entries) |
                .download_links = (.download_links | to_entries | 
                  map(select(.key as $k | $k | in(.version_metadata))) | 
                  from_entries)
              ' downloads_data.json.new > downloads_data.json.filtered
              
              REMOVED=$(( $(jq '.version_metadata | length' downloads_data.json.new) - $(jq '.version_metadata | length' downloads_data.json.filtered) ))
              echo "    âœ“ Removed $REMOVED old versions (cutoff: $CUTOFF_DATE)"
              mv downloads_data.json.filtered downloads_data.json.new
            fi
            
            # Limit max versions
            MAX_VERSIONS="${{ github.event.inputs.max_versions }}"
            if [ "$MAX_VERSIONS" != "0" ] && [ -n "$MAX_VERSIONS" ]; then
              echo "  ğŸ“Š Limiting to $MAX_VERSIONS most recent versions..."
              
              jq --argjson max "$MAX_VERSIONS" '
                (.version_metadata | to_entries | 
                  sort_by(.value.release_date) | reverse | 
                  .[:$max] | 
                  from_entries) as $kept_metadata |
                {
                  generated_at,
                  version_metadata: $kept_metadata,
                  download_links: (.download_links | to_entries | 
                    map(select(.key | in($kept_metadata))) | 
                    from_entries)
                }
              ' downloads_data.json.new > downloads_data.json.limited
              
              KEPT=$(jq '.version_metadata | length' downloads_data.json.limited)
              echo "    âœ“ Kept $KEPT most recent versions"
              mv downloads_data.json.limited downloads_data.json.new
            fi
            
            echo ""
            echo "ğŸ“Š Final version count: $(jq '.version_metadata | length' downloads_data.json.new)"
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "existing/downloads_data.json" ]; then
            # Compare checksums (ignoring generated_at timestamp)
            OLD_CONTENT=$(jq 'del(.generated_at)' existing/downloads_data.json | md5sum | cut -d' ' -f1)
            NEW_CONTENT=$(jq 'del(.generated_at)' downloads_data.json.new | md5sum | cut -d' ' -f1)
            
            if [ "$OLD_CONTENT" == "$NEW_CONTENT" ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo ""
              echo "â„¹ï¸  No changes detected in downloads_data.json"
              echo ""
              echo "ğŸ“Š Comparison:"
              echo "  Old: $(jq '.version_metadata | length' existing/downloads_data.json) versions"
              echo "  New: $(jq '.version_metadata | length' downloads_data.json.new) versions"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo ""
              echo "ğŸ”„ Changes detected!"
              echo ""
              echo "ğŸ“Š Comparison:"
              echo "  Old: $(jq '.version_metadata | length' existing/downloads_data.json) versions"
              echo "  New: $(jq '.version_metadata | length' downloads_data.json.new) versions"
            fi
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ†• First time generation - no existing file"
          fi
      
      - name: Dry run summary
        if: github.event.inputs.dry_run == 'true' && (steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true')
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” DRY RUN - Preview Only (No Changes Saved)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Changes that would be made:"
          echo ""
          echo "New downloads_data.json content:"
          echo "  - Size: $(du -h downloads_data.json.new | cut -f1)"
          echo "  - Versions: $(jq '.version_metadata | length' downloads_data.json.new)"
          echo ""
          echo "ğŸ“‹ Versions that would be published:"
          jq -r '.version_metadata | to_entries[] | "  - \(.key) (\(.value.release_date))"' downloads_data.json.new | sort -V
          echo ""
          echo "â„¹ï¸  To actually apply these changes, run without dry_run option"
          echo ""
      
      - name: Upload to main-devel release
        if: (steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ Uploading downloads_data.json to main-devel release"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Rename to final name
          mv downloads_data.json.new downloads_data.json
          
          # Upload to main-devel release
          # This is where documentation.yml will fetch it from
          gh release upload main-devel downloads_data.json --clobber
          
          echo ""
          echo "âœ… downloads_data.json uploaded to main-devel release"
          echo "  - Versions: $(jq '.version_metadata | length' downloads_data.json)"
          echo ""
          echo "ğŸ“ Note: This file will be picked up by documentation.yml during deployment"
          echo "   The actual GitHub Pages site is deployed by documentation.yml workflow"
          echo ""
          echo "ğŸ”— Direct download: https://github.com/${{ github.repository }}/releases/download/main-devel/downloads_data.json"

      - name: Summary (No changes)
        if: steps.check_changes.outputs.has_changes == 'false' && github.event.inputs.force_update != 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â„¹ï¸  No Update Required"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Downloads data is already up-to-date."
          echo "  - Current versions: $(jq '.version_metadata | length' existing/downloads_data.json)"
          echo ""
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ’¡ Manual Trigger Tips:"
            echo "  - Use 'force_update: true' to save even without changes"
            echo "  - Use 'trigger_docs_deploy: true' to also trigger documentation deployment"
            echo "  - Use 'cleanup_old_versions' to remove old releases"
            echo "  - Use 'max_versions' to limit version count"
            echo "  - Use 'dry_run: true' to preview changes without saving"
            echo ""
          fi

  # Optional: Trigger documentation workflow to deploy with updated downloads_data.json
  trigger-docs-deploy:
    needs: update-downloads-data
    if: |
      (needs.update-downloads-data.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true') &&
      github.event.inputs.dry_run != 'true' &&
      github.event.inputs.trigger_docs_deploy == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger documentation workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸš€ Triggering documentation workflow..."
          gh workflow run documentation.yml \
            --repo ${{ github.repository }} \
            --ref main
          echo "âœ… Documentation workflow triggered"
          echo "   The updated downloads_data.json will be included in the deployment"
