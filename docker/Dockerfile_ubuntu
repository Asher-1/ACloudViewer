ARG EROWCLOUDVIEWER_VERSION
ARG VTK_VERSION
ARG PCL_VERSION
ARG CUDA_VERSION
ARG UBUNTU_VERSION
FROM erowcloudviewer-deps:${EROWCLOUDVIEWER_VERSION}-ubuntu${UBUNTU_VERSION}-cuda${CUDA_VERSION}
LABEL maintainer="AliceVision Team ludahai19@163.com"

# Execute with nvidia docker (https://github.com/nvidia/nvidia-docker/wiki/Installation-(version-2.0))
# docker run -it --runtime nvidia -p 2222:22 --name cloudViewer -v</path/to/your/data>:/data erowcloudviewer:develop-ubuntu18.04-cuda10.2
# ssh -p 2222 -X root@<docker host> /opt/ErowCloudViewer # Password is 'erowcloudviewer'

ENV EROWCLOUDVIEWER_DEV=/opt/ErowCloudViewer \
    EROWCLOUDVIEWER_BUILD=/tmp/ErowCloudViewer_build \
    BUNDLE_CLOUDVIEWER_ML=/opt/ErowCloudViewer/CloudViewer-ML \
    AV_INSTALL=/opt/AliceVision_install \
    QT_DIR=/opt/Qt5.14.2/5.14.2/gcc_64 \
    PATH="${PATH}:${BUNDLE_CLOUDVIEWER_ML}"

COPY . ${EROWCLOUDVIEWER_DEV}/ErowCloudViewer

WORKDIR ${EROWCLOUDVIEWER_BUILD}

# fix conflicts between python object.h and qt head file
RUN sed -i "s/PyType_Slot \*slots/PyType_Slot \*_slots/g" /root/miniconda3/include/python3.6m/object.h

# Build ErowCloudViewer plugins
RUN cmake "${EROWCLOUDVIEWER_DEV}/ErowCloudViewer" \
                            -DCMAKE_BUILD_TYPE=Release \
                            -DBUILD_JUPYTER_EXTENSION=ON \
                            -DBUILD_LIBREALSENSE=ON \
                            -DBUILD_AZURE_KINECT=ON \
                            -DBUILD_RPC_INTERFACE=ON \
                            -DBUILD_BENCHMARKS=OFF \
                            -DWITH_OPENMP=ON \
                            -DBUILD_CUDA_MODULE=ON \
                            -DBUILD_PYTORCH_OPS=ON \
                            -DBUILD_TENSORFLOW_OPS=ON \
                            -DPYTHON_EXECUTABLE=/root/miniconda3/bin/python3.6 \
                            -DPYTHON_IN_PATH=/root/miniconda3/bin/python3.6 \
                            -DPYTHON_LIBRARY=/root/miniconda3/lib/libpython3.6m.so \
                            #-DBUNDLE_CLOUDVIEWER_ML=ON \
                            #-DCLOUDVIEWER_ML_ROOT="${BUNDLE_CLOUDVIEWER_ML}" \
                            -DQT_QMAKE_EXECUTABLE:PATH=${QT_DIR}/bin/qmake \
                            -DCMAKE_PREFIX_PATH:PATH=${QT_DIR}/lib/cmake \
                            -DCMAKE_INSTALL_PREFIX=${EROWCLOUDVIEWER_DEV}/install
RUN make "-j$(nproc)" pip-package \
    #&& make "-j$(nproc)" install-pip-package \
    #&& make "-j$(nproc)" conda-package \
    && make install "-j$(nproc)" \
    && rm -rf ${EROWCLOUDVIEWER_BUILD}

WORKDIR /root